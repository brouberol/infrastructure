- include_tasks: Debian_jessie.yml
  when: ansible_distribution == 'Debian' and ansible_distribution_release == 'jessie'

- include_tasks: Ubuntu.yml
  when: ansible_distribution == 'Ubuntu'

- name: "Check whether port 443 is available to avoid that certbot fails and returns: 'Could not bind TCP port 443 because it is already in use by another process'"
  wait_for:
    port: 443
    state: stopped
    timeout: "{{ certbot_waitfor_port_seconds }}"
  when: certbot_create_certs

- name: certs created
  command: certbot certonly --standalone -d {{ item }} -m {{ certbot_mail_address }} --agree-tos --noninteractive --text
  args:
    creates: "{{ certbot_live_home }}/{{ item }}/fullchain.pem"
  when: certbot_create_certs
  with_items:
    - "{{ certbot_list_of_certs_to_create }}"

- name: renew certs
  cron:
    name: renewCertbotCerts
    user: root
    minute: "{{ certbot_renew_certs_minute }}"
    hour: "{{ certbot_renew_certs_hour }}"
    month: "{{ certbot_renew_certs_month }}"
    weekday: "{{ certbot_renew_certs_weekday }}"
    day: "{{ certbot_renew_certs_day }}"
    job: "{{ certbot_renew_certs_job }}"
    state: present
    disabled: no
  when: certbot_renew_certs

- name: "Remove default certbot cron job"
  file:
    path: /etc/cron.d/certbot
    state: absent
